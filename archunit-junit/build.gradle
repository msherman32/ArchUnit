ext.moduleName = 'com.tngtech.archunit.junit'

dependencies {
    compile project(path: ':archunit', configuration: 'shadow')
    compile dependency.guava
    compile dependency.slf4j

    testCompile dependency.log4j_api
    testCompile dependency.log4j_core
    testCompile dependency.log4j_slf4j
    testCompile dependency.mockito
    testCompile dependency.assertj
    testCompile(dependency.assertj_guava) {
        exclude module: 'assertj-core'
        exclude module: 'guava'
    }
    testCompile project(path: ':archunit', configuration: 'tests')
}

addTestJarTo this

shadowJar {
    exclude 'META-INF/**'

    dependencies {
        exclude(project(':archunit'))
        exclude(dependency(dependency.slf4j))
    }
}

def addCleanThirdPartyTask = {
    // These files are already relocated into archunit.jar, so they're transitively available
    tasks.create(name: 'removeDuplicateThirdParty', type: Jar, dependsOn: shadowJar) {
        exclude "${thirdPartyRelocationPackage.replace('.', '/')}/**"

        File tempPath = tempJar(jar.archivePath)
        from zipTree(shadowJar.archivePath)
        archiveName tempPath.name

        doLast {
            assert shadowJar.archivePath.delete()
            assert tempPath.renameTo(shadowJar.archivePath)
        }
    }
    finishArchive.dependsOn removeDuplicateThirdParty
}
ext.configureJUnitArchive = {
    delegate.with addCleanThirdPartyTask
    compileJava.dependsOn project(':archunit-junit').finishArchive

    def configureDependencies = { pom ->
        pom.dependencies.removeAll {
            it.scope != 'compile' || !(it.artifactId in ['archunit', 'junit'])
        }
        pom.dependencies.find { it.artifactId == 'archunit' }.classifier = null
    }
    install.repositories.mavenInstaller.pom.whenConfigured configureDependencies
    uploadArchives.repositories.mavenDeployer.pom.whenConfigured configureDependencies
}

this.with addCleanThirdPartyTask